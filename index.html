<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Local HelpBot</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/particles.js@2.0.0/particles.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.3s ease, color 0.3s ease;
      overflow-x: hidden;
    }
    body.dark {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #ffffff;
    }
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      z-index: -1;
    }
    .navbar {
      width: 100%;
      max-width: 1200px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      margin: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 10;
    }
    .navbar h1 {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
    }
    body.dark .navbar h1 {
      color: #ffffff;
    }
    .navbar select {
      padding: 0.5rem;
      border-radius: 5px;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    body.dark .navbar select {
      background: rgba(0, 0, 0, 0.5);
      color: #ffffff;
    }
    .navbar select:hover {
      transform: scale(1.05);
    }
    .navbar button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 5px;
      background: #f97316;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .navbar button:hover {
      background: #ea580c;
      transform: scale(1.05);
    }
    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .chat-container {
      width: 100%;
      max-width: 800px;
      margin: 1rem;
    }
    .chat-area {
      height: 400px;
      overflow-y: auto;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .chat-bubble {
      padding: 0.75rem 1rem;
      border-radius: 10px;
      max-width: 70%;
      word-wrap: break-word;
      animation: slideIn 0.3s ease;
      margin-bottom: 0.5rem;
    }
    .chat-bubble.user {
      background: #f97316;
      color: white;
      margin-left: auto;
      text-align: right;
    }
    .chat-bubble.bot {
      background: #1d4ed8;
      color: white;
      margin-right: auto;
    }
    .chat-bubble.error {
      background: #dc2626;
      color: white;
      margin-right: auto;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .input-container {
      display: flex;
      gap: 0.5rem;
    }
    .input-container input {
      flex: 1;
      padding: 0.75rem;
      border-radius: 5px;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      font-size: 1rem;
      outline: none;
    }
    body.dark .input-container input {
      background: rgba(0, 0, 0, 0.5);
      color: #ffffff;
    }
    .input-container button {
      padding: 0.75rem;
      border-radius: 5px;
      border: none;
      background: #f97316;
      color: white;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .input-container button:hover {
      background: #ea580c;
      transform: scale(1.05);
    }
    .mic-listening {
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .thinking::after {
      content: '.';
      animation: dots 1.5s infinite;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60% { content: '...'; }
      80%, 100% { content: '.'; }
    }
    .footer {
      margin-top: auto;
      padding: 1rem;
      text-align: center;
      color: #666;
      font-size: 0.9rem;
    }
    body.dark .footer {
      color: #ccc;
    }
    @media (max-width: 640px) {
      .navbar {
        flex-direction: column;
        gap: 1rem;
      }
      .chat-bubble {
        max-width: 85%;
      }
      .input-container {
        flex-direction: column;
      }
      .input-container button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="particles-js"></div>
  <div id="root"></div>
  <script>
    var translations = {
      en: {
        title: "Local HelpBot",
        placeholder: "Ask me anything...",
        send: "Send",
        voiceInput: "Voice Input",
        darkMode: "Toggle Dark Mode",
        greeting: "Hello! How can I assist you today?",
        thinking: "Thinking",
        fetchError: "Sorry, I couldn't fetch a response. Please try again.",
        locationError: "Unable to access location. Please try again or call 211.",
        geolocationUnsupported: "Geolocation is not supported by your browser. Please try again or call 211.",
        micError: "Microphone access denied. Please enable it to use voice input.",
        micPermissionError: "Error accessing microphone",
        speechError: "Speech recognition error: ",
        footer: "Local HelpBot © 2023 | No cookies or tracking used."
      },
      es: {
        title: "Local HelpBot",
        placeholder: "Pregúntame cualquier cosa...",
        send: "Enviar",
        voiceInput: "Entrada de voz",
        darkMode: "Alternar modo oscuro",
        greeting: "¡Hola! ¿Cómo puedo ayudarte hoy?",
        thinking: "Pensando",
        fetchError: "Lo siento, no pude obtener una respuesta. Por favor, intenta de nuevo.",
        locationError: "No se pudo acceder a la ubicación. Por favor, intenta de nuevo o llama al 211.",
        geolocationUnsupported: "La geolocalización no es compatible con tu navegador. Por favor, intenta de nuevo o llama al 211.",
        micError: "Acceso al micrófono denegado. Por favor, habilítalo para usar la entrada de voz.",
        micPermissionError: "Error al acceder al micrófono",
        speechError: "Error de reconocimiento de voz: ",
        footer: "Local HelpBot © 2023 | Sin cookies ni seguimiento."
      },
      fr: {
        title: "Local HelpBot",
        placeholder: "Demandez-moi n'importe quoi...",
        send: "Envoyer",
        voiceInput: "Entrée vocale",
        darkMode: "Basculer en mode sombre",
        greeting: "Bonjour ! Comment puis-je vous aider aujourd'hui ?",
        thinking: "En réflexion",
        fetchError: "Désolé, je n'ai pas pu obtenir de réponse. Veuillez réessayer.",
        locationError: "Impossible d'accéder à la localisation. Veuillez réessayer ou appeler le 211.",
        geolocationUnsupported: "La géolocalisation n'est pas prise en charge par votre navigateur. Veuillez réessayer ou appeler le 211.",
        micError: "Accès au microphone refusé. Veuillez l'activer pour utiliser l'entrée vocale.",
        micPermissionError: "Erreur d'accès au microphone",
        speechError: "Erreur de reconnaissance vocale : ",
        footer: "Local HelpBot © 2023 | Aucun cookie ni suivi utilisé."
      }
    };

    var locationKeywords = [
      "near me",
      "nearby",
      "close to me",
      "around me",
      "in my area",
      "local"
    ];

    var App = function App() {
      var _React$useState = React.useState([]),
          messages = _React$useState[0],
          setMessages = _React$useState[1];
      var _React$useState2 = React.useState("en"),
          language = _React$useState2[0],
          setLanguage = _React$useState2[1];
      var _React$useState3 = React.useState(false),
          isDarkMode = _React$useState3[0],
          setIsDarkMode = _React$useState3[1];
      var _React$useState4 = React.useState(null),
          speechError = _React$useState4[0],
          setSpeechError = _React$useState4[1];
      var _React$useState5 = React.useState(false),
          isListening = _React$useState5[0],
          setIsListening = _React$useState5[1];
      var t = translations[language];

      React.useEffect(function () {
        try {
          particlesJS("particles-js", {
            particles: {
              number: { value: 100, density: { enable: true, value_area: 800 } },
              color: { value: isDarkMode ? "#F97316" : "#E5E7EB" },
              shape: { type: "circle" },
              opacity: { value: 0.5, random: false },
              size: { value: 3, random: true },
              line_linked: {
                enable: true,
                distance: 150,
                color: isDarkMode ? "#F97316" : "#E5E7EB",
                opacity: 0.4,
                width: 1
              },
              move: { enable: true, speed: 6, direction: "none", random: false }
            },
            interactivity: {
              detect_on: "canvas",
              events: {
                onhover: { enable: true, mode: "repulse" },
                onclick: { enable: true, mode: "push" },
                resize: true
              }
            },
            retina_detect: true
          });
        } catch (error) {
          console.error("Particles.js initialization failed:", error);
        }
      }, [isDarkMode]);

      React.useEffect(function () {
        navigator.permissions.query({ name: "microphone" }).then(function (result) {
          if (result.state === "denied") {
            setSpeechError(t.micError);
          }
        }).catch(function (error) {
          setSpeechError(t.micPermissionError + " (" + error.message + ")");
        });
      }, [t]);

      var addErrorMessage = function addErrorMessage(errorText) {
        setMessages(function (prev) {
          return [].concat(prev, [{ sender: "bot", text: errorText, isError: true }]);
        });
      };

      var toggleDarkMode = function toggleDarkMode() {
        setIsDarkMode(!isDarkMode);
        document.body.classList.toggle("dark");
      };

      var handleSpeechRecognition = function handleSpeechRecognition() {
        if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
          setSpeechError(t.speechError + "Speech recognition is not supported in this browser.");
          return;
        }
        var recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = language === "en" ? "en-US" : language === "es" ? "es-ES" : "fr-FR";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        setIsListening(true);
        setSpeechError(null);
        recognition.onresult = function (event) {
          var transcript = event.results[0][0].transcript;
          sendMessage(transcript);
          setIsListening(false);
        };
        recognition.onerror = function (event) {
          setIsListening(false);
          setSpeechError(t.speechError + event.error);
        };
        recognition.onend = function () {
          setIsListening(false);
        };
        try {
          recognition.start();
        } catch (error) {
          setIsListening(false);
          setSpeechError(t.speechError + "Failed to start speech recognition.");
        }
      };

      var fetchGPTResponse = function fetchGPTResponse(lat, lon, prompt, language, isLocationQuery) {
        return new Promise(function (resolve) {
          var body = { prompt: prompt, language: language };
          if (isLocationQuery && lat && lon) {
            body.location = { lat: lat, lon: lon };
          }
          fetch('http://localhost:3000/api/gpt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          })
            .then(function (response) {
              if (!response.ok) throw new Error('Network response was not ok: ' + response.statusText);
              return response.json();
            })
            .then(function (data) {
              return resolve(data.response || t.fetchError);
            })
            .catch(function (error) {
              console.error("Fetch error:", error);
              resolve(t.fetchError);
            });
        });
      };

      var sendMessage = function sendMessage(text) {
        if (!text.trim()) return;
        setMessages(function (prev) {
          return [].concat(prev, [{ sender: "user", text: text }]);
        });
        setMessages(function (prev) {
          return [].concat(prev, [{ sender: "bot", text: t.thinking, isThinking: true }]);
        });

        if (["hey", "hi", "hello"].some(function (greeting) {
          return text.toLowerCase().includes(greeting);
        })) {
          setMessages(function (prev) {
            return [].concat(prev.filter(function (msg) {
              return !msg.isThinking;
            }), [{ sender: "bot", text: t.greeting }]);
          });
          return;
        }

        var isLocationQuery = locationKeywords.some(function (keyword) {
          return text.toLowerCase().includes(keyword);
        });
        if (isLocationQuery && navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              var lat = position.coords.latitude;
              var lon = position.coords.longitude;
              fetchGPTResponse(lat, lon, text, language, true)
                .then(function (response) {
                  setMessages(function (prev) {
                    return [].concat(prev.filter(function (msg) {
                      return !msg.isThinking;
                    }), [{ sender: "bot", text: response || t.fetchError, isError: !response }]);
                  });
                })
                .catch(function (error) {
                  console.error("Error fetching DeepSeek response:", error);
                  addErrorMessage(t.fetchError);
                });
            },
            function (error) {
              console.error("Geolocation error:", error);
              addErrorMessage(t.locationError);
            }
          );
        } else {
          fetchGPTResponse(null, null, text, language, false)
            .then(function (response) {
              setMessages(function (prev) {
                return [].concat(prev.filter(function (msg) {
                  return !msg.isThinking;
                }), [{ sender: "bot", text: response || t.fetchError, isError: !response }]);
              });
            })
            .catch(function (error) {
              console.error("Error fetching DeepSeek response:", error);
              addErrorMessage(t.fetchError);
            });
        }
      };

      var NavBar = function NavBar() {
        return React.createElement(
          "div",
          { className: "navbar" },
          React.createElement(
            "h1",
            null,
            t.title
          ),
          React.createElement(
            "div",
            { className: "flex space-x-2" },
            React.createElement(
              "select",
              {
                value: language,
                onChange: function onChange(e) {
                  return setLanguage(e.target.value);
                },
                "aria-label": "Select language"
              },
              React.createElement("option", { value: "en" }, "English"),
              React.createElement("option", { value: "es" }, "Español"),
              React.createElement("option", { value: "fr" }, "Français")
            ),
            React.createElement(
              "button",
              {
                onClick: toggleDarkMode,
                "aria-label": t.darkMode
              },
              React.createElement("i", { className: "fas fa-moon" }),
              " ",
              t.darkMode
            )
          )
        );
      };

      var ChatArea = function ChatArea(_ref) {
        var messages = _ref.messages,
            sendMessage = _ref.sendMessage,
            language = _ref.language;
        var t = translations[language];
        var chatRef = React.useRef(null);

        React.useEffect(function () {
          if (chatRef.current) {
            chatRef.current.scrollTop = chatRef.current.scrollHeight;
          }
        }, [messages]);

        return React.createElement(
          "div",
          { className: "chat-container glass" },
          React.createElement(
            "div",
            { ref: chatRef, className: "chat-area" },
            messages.map(function (msg, index) {
              return React.createElement(
                "div",
                {
                  key: index,
                  className: "chat-bubble " + (msg.sender === "user" ? "user" : msg.isError ? "error" : "bot")
                },
                msg.text
              );
            }),
            speechError && React.createElement(
              "div",
              { className: "chat-bubble error" },
              speechError
            )
          ),
          React.createElement(
            "div",
            { className: "input-container" },
            React.createElement("input", {
              id: "chatInput",
              type: "text",
              placeholder: t.placeholder,
              onKeyPress: function onKeyPress(e) {
                if (e.key === "Enter") {
                  sendMessage(e.target.value);
                  e.target.value = "";
                }
              },
              "aria-label": "Chat input"
            }),
            React.createElement(
              "button",
              {
                onClick: function onClick() {
                  var input = document.getElementById("chatInput");
                  sendMessage(input.value);
                  input.value = "";
                },
                "aria-label": t.send
              },
              React.createElement("i", { className: "fas fa-paper-plane" }),
              " ",
              t.send
            ),
            React.createElement(
              "button",
              {
                onClick: handleSpeechRecognition,
                className: isListening ? "mic-listening" : "",
                "aria-label": t.voiceInput,
                disabled: isListening
              },
              React.createElement("i", { className: "fas fa-microphone" }),
              " ",
              t.voiceInput
            )
          )
        );
      };

      var Footer = function Footer() {
        return React.createElement(
          "footer",
          { className: "footer" },
          t.footer
        );
      };

      return React.createElement(
        React.Fragment,
        null,
        React.createElement(NavBar, null),
        React.createElement(ChatArea, {
          messages: messages,
          sendMessage: sendMessage,
          language: language
        }),
        React.createElement(Footer, null)
      );
    };

    var root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</body>
</html>